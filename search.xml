<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>两主三从数据库集群主备重做方法</title>
      <link href="/2022/02/22/liang-zhu-san-cong-shu-ju-ku-ji-qun-zhu-bei-chong-zuo-fang-fa/"/>
      <url>/2022/02/22/liang-zhu-san-cong-shu-ju-ku-ji-qun-zhu-bei-chong-zuo-fang-fa/</url>
      
        <content type="html"><![CDATA[<h2 id="集群结构图"><a href="#集群结构图" class="headerlink" title="集群结构图"></a>集群结构图</h2><p>​    该集群一共有五台设备，其中两台主，三台备。两台主机相互同步，三台主机各自分为两个通道同步两台主机，以达到数据同步到效果。</p><p><img src="https://cdn.jsdelivr.net/gh/LongShengWen/image@main/data/202201291017365.png" alt="结构图"></p><h2 id="主从同步恢复"><a href="#主从同步恢复" class="headerlink" title="主从同步恢复"></a>主从同步恢复</h2><p>在某些情况下，导致同步出错，需要重做主备来恢复数据库。</p><h3 id="制作数据包"><a href="#制作数据包" class="headerlink" title="制作数据包"></a>制作数据包</h3><p>选取一台数据相对准确的主机，这里我们选择Master1。登录机器制作全库数据包</p><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">mysqldump -uroot -p*** --single-transaction --no-autocommit --set-gtid-purged=OFF --master-data=2 -A &gt;test.sql<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="查看数据包复制节点"><a href="#查看数据包复制节点" class="headerlink" title="查看数据包复制节点"></a>查看数据包复制节点</h3><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">head -25 test.sql<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>执行以上代码，回得到下面的输出结果</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">-- MySQL dump 10.13  Distrib 8.0.22, for Linux (x86_64)---- Host: localhost    Database:-- -------------------------------------------------------- Server version8.0.22/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;/*!50503 SET NAMES utf8mb4 */;/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */;/*!40103 SET TIME_ZONE='+00:00' */;/*!50606 SET @OLD_INNODB_STATS_AUTO_RECALC=@@INNODB_STATS_AUTO_RECALC */;/*!50606 SET GLOBAL INNODB_STATS_AUTO_RECALC=OFF */;/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;---- Position to start replication or point-in-time recovery from---- CHANGE MASTER TO MASTER_LOG_FILE='binlog.000188', MASTER_LOG_POS=2316558;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>CHANGE MASTER TO MASTER_LOG_FILE=’binlog.000188’, MASTER_LOG_POS=2316558;</p></blockquote><p>这个就是我们想要的数据。</p><h3 id="同步主库Master2"><a href="#同步主库Master2" class="headerlink" title="同步主库Master2"></a>同步主库Master2</h3><p>到这里就用test.sql 数据包同步另主库Master2了。</p><h3 id="停止binlog输出"><a href="#停止binlog输出" class="headerlink" title="停止binlog输出"></a>停止binlog输出</h3><p>登录数据库，执行以下代码</p><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">set sql_log_bin=0;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="导入数据"><a href="#导入数据" class="headerlink" title="导入数据"></a>导入数据</h3><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">mysql -uroot -p*** &lt; /data/test.sql<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>将test.sql 导入进 Msater2中。</p><h3 id="清除同步信息"><a href="#清除同步信息" class="headerlink" title="清除同步信息"></a>清除同步信息</h3><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">stop slave;reset slave all; show slave status\G;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这一步主要是清除一下无效的同步信息。</p><h3 id="开启同步"><a href="#开启同步" class="headerlink" title="开启同步"></a>开启同步</h3><p>设置同步的节点。</p><pre class="line-numbers language-none"><code class="language-none">change master to master_host='172.30.4.5',master_user='slave',master_password='***',master_log_file='binlog.000188',master_log_pos=2316558;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这里的 master_log_file 和 master_log_pos 数据就是从test.sql数据包中提取的信息。  </p><h5 id="开始同步"><a href="#开始同步" class="headerlink" title="开始同步"></a>开始同步</h5><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql"># 开启同步start slave;# 查看同步状态show slave status\G;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">       Slave_IO_State: Waiting for master to send event          Master_Host: 172.30.4.5          Master_User: slave          Master_Port: 3306        Connect_Retry: 60      Master_Log_File: binlog.000188  Read_Master_Log_Pos: 2324194       Relay_Log_File: relaylog-5.000002        Relay_Log_Pos: 7949Relay_Master_Log_File: binlog.000188     Slave_IO_Running: Yes    Slave_SQL_Running: Yes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>Slave_IO_Running 和 Slave_SQL_Running 两个状态都为Yes即说明同步状态正常。    </p></blockquote><h4 id="恢复binlog日志"><a href="#恢复binlog日志" class="headerlink" title="恢复binlog日志"></a>恢复binlog日志</h4><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">set sql_log_bin=1;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>到这另一个主机的同步就完成了。</p><h3 id="同步主库Master1"><a href="#同步主库Master1" class="headerlink" title="同步主库Master1"></a>同步主库Master1</h3><p>因为两个主库是互为同步的，所以还得开启Master1的同步。</p><h4 id="查看Master2同步信息"><a href="#查看Master2同步信息" class="headerlink" title="查看Master2同步信息"></a>查看Master2同步信息</h4><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">mysql&gt; show master status \G;*************************** 1. row ***************************             File: binlog.000010         Position: 2451890     Binlog_Do_DB: Binlog_Ignore_DB:Executed_Gtid_Set: 4b33e04d-4987-11eb-9488-005056a98e78:1-391638:391640-840695:936025:936029:936039:936049:936069:936091:936117:936199:936203:936208:936240-936243,5987abbe-4987-11eb-af11-005056a96f47:1-25968:50772-94390:9359851 row in set (0.00 sec)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="开启同步-1"><a href="#开启同步-1" class="headerlink" title="开启同步"></a>开启同步</h4><p>登录 Master1 数据库。</p><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">change master to master_host='172.30.4.6',master_user='slave',master_password='***',master_log_file='binlog.000010',master_log_pos=2451890;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql"># 开启同步start slave;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>到这两台主机的同步就算完成了。</p><h4 id="同步从库"><a href="#同步从库" class="headerlink" title="同步从库"></a>同步从库</h4><p>因为三台从库的同步步骤都是一样的，所以这里写一台的同步流程。</p><h4 id="导入数据-1"><a href="#导入数据-1" class="headerlink" title="导入数据"></a>导入数据</h4><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">mysql -uroot -p*** &lt; /data/test.sql<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="重置同步信息"><a href="#重置同步信息" class="headerlink" title="重置同步信息"></a>重置同步信息</h4><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">stop slave;reset slave all; show slave status\G;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="查看Msater2信息"><a href="#查看Msater2信息" class="headerlink" title="查看Msater2信息"></a>查看Msater2信息</h4><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">mysql&gt; show master status \G;*************************** 1. row ***************************             File: binlog.000010         Position: 2459707     Binlog_Do_DB: Binlog_Ignore_DB:Executed_Gtid_Set: 4b33e04d-4987-11eb-9488-005056a98e78:1-391638:391640-840695:936025:936029:936039:936049:936069:936091:936117:936199:936203:936208:936240-936243,5987abbe-4987-11eb-af11-005056a96f47:1-25980:50772-94390:9359851 row in set (0.00 sec)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>因为这些信息是变化的，所以每台从库都应取最新的。</p></blockquote><h4 id="设置同步通道信息"><a href="#设置同步通道信息" class="headerlink" title="设置同步通道信息"></a>设置同步通道信息</h4><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">change master to master_host='172.30.4.5',master_user='slave',master_password='***',master_log_file='binlog.000188',master_log_pos=2316558 for channel '5';<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">change master to master_host='172.30.4.6',master_user='slave',master_password='***',master_log_file='binlog.000010',master_log_pos=2459707 for channel '6';<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>因为数据包是由 .5 制作的，所以通道5用的是数据包的同步节点信息。通道6用的是Master2的同步节点信息。</p><h4 id="开启同步-2"><a href="#开启同步-2" class="headerlink" title="开启同步"></a>开启同步</h4><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql"># 开启同步start slave;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>到这就完成了一个节点的同步了，重复上述步骤完成其他节点的同步制作即可完成整个集群的同步。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
          <category> MySQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
